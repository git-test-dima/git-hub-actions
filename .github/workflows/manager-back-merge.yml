name: Back Merge Manager

on:
  workflow_call:
    inputs:
      back_merge_targets:
        required: true
        type: string
        description: "Comma-separated list of target branches for back-merge"
    secrets:
      WORKFLOW:
        required: true

jobs:
  perform-back-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Prepare back-merge
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0
          token: ${{ secrets.WORKFLOW }}

      - name: Perform back-merge
        run: |
          set -eo pipefail

          echo "ğŸ”§ Configuring Git user"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "ğŸ”‘ Setting up authentication"
          git remote set-url origin https://x-access-token:${{ secrets.WORKFLOW }}@github.com/${{ github.repository }}

          echo "ğŸ” Testing authentication..."
          git ls-remote --heads origin > /dev/null || { echo "âŒ Authentication failed"; exit 1; }
          echo "âœ… Authentication successful"

          echo "ğŸ“¥ Fetching all branches"
          git fetch --all --prune

          echo "ğŸ§¹ Ensuring clean working directory"
          git reset --hard HEAD
          git clean -fd

          IFS=',' read -ra TARGETS <<< "${{ inputs.back_merge_targets }}"
          for target in "${TARGETS[@]}"; do
            echo "ğŸ“¥ Fetching target branch: $target"
            git fetch origin $target:$target || echo "âš ï¸ No remote $target branch"
          done

          echo "ğŸ” Current branch: ${{ github.ref_name }}"
          echo "ğŸ“‹ Available branches:"
          git branch -a

          # Verify source branch exists
          if ! git show-ref --verify --quiet refs/heads/${{ github.ref_name }}; then
            echo "âŒ Source branch '${{ github.ref_name }}' does not exist locally"
            exit 1
          fi
          echo "âœ… Source branch '${{ github.ref_name }}' exists locally"

          for target in "${TARGETS[@]}"; do
            echo "ğŸš€ Merging ${{ github.ref_name }} into $target"
            
            # Check if target branch exists
            if ! git show-ref --verify --quiet refs/heads/$target; then
              echo "âŒ Target branch '$target' does not exist locally"
              echo "ğŸ“¥ Trying to fetch it from remote..."
              git fetch origin $target:$target || {
                echo "âŒ Failed to fetch target branch '$target' from remote"
                echo "ğŸ” Available remote branches:"
                git ls-remote --heads origin
                exit 1
              }
            fi
            
            echo "âœ… Target branch '$target' exists locally"
            
            echo "ğŸ”„ Switching to target branch: $target"
            # Clean any uncommitted changes that might prevent checkout
            git reset --hard HEAD
            git clean -fd
            git checkout $target || {
              echo "âŒ Failed to checkout target branch '$target'"
              echo "ğŸ” Checking available branches:"
              git branch -a
              echo "ğŸ” Checking current status:"
              git status
              exit 1
            }
            
            echo "ğŸ”€ Attempting merge..."
            MERGE_OUTPUT=$(git merge ${{ github.ref_name }} --no-ff --no-commit 2>&1)
            MERGE_EXIT_CODE=$?
            
            echo "ğŸ“ Merge output: $MERGE_OUTPUT"
            echo "ğŸ”¢ Merge exit code: $MERGE_EXIT_CODE"
            
            if [ $MERGE_EXIT_CODE -eq 0 ]; then
              if echo "$MERGE_OUTPUT" | grep -q "Already up to date"; then
                echo "âœ… Already up to date - no conflicts, job completed successfully"
              else
                echo "âœ… Merge successful"
                git commit -m "ğŸ”„ Back-merge ${{ github.ref_name }} into $target"
                echo "ğŸ“¤ Pushing to remote..."
                git push origin $target || {
                  echo "âŒ Failed to push to remote. This might be due to:"
                  echo "   - Branch protection rules"
                  echo "   - Insufficient permissions"
                  echo "   - Network issues"
                  exit 1
                }
                echo "âœ… Push successful"
              fi
            else
              echo "âŒ Merge conflict detected! Aborting..."
              echo "Merge output: $MERGE_OUTPUT"
              git merge --abort
              echo "ğŸ” Checking for conflicts..."
              git status
              exit 1
            fi
          done
